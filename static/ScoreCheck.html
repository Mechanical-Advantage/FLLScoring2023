<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>FLL Scoring</title>
        <script type="text/javascript">
            var dict = {};
            // var dict = {
            //     mission0a: 1,
            //     mission1a: 1,
            //     mission2a: 1,
            //     mission2b: 0,
            //     mission3a: 0,
            //     mission4a: 0,
            //     mission4b: 0,
            //     mission5a: 0,
            //     mission6a: 0,
            //     mission6b: 0,
            //     mission7a: 0,
            //     mission8a: 0,
            //     mission9a: 0,
            //     mission9b: 0,
            //     mission10a: 0,
            //     mission11a: 0,
            //     mission12a: 0,
            //     mission12b: 0,
            //     mission13a: 0,
            //     mission13b: 0,
            //     mission14a: 0,
            //     mission14b: 0,
            //     mission15a: 0,
            //     mission15b: 0,
            //     mission15c: 0,
            //     mission15d: 0,
            //     mission15e: 0,
            //     missionPT: "0"
            // };
            var dictString = "text";

            console.log("starting dict:");
            console.log(dict);

            function total_score() {
                var score = 0;
                var mission0a = document.getElementById("M00a");
                if (dict.mission0a == 1) {
                    score += 20;
                    mission0a.checked = true;
                } else {
                    mission0a.checked = false;
                }

                var mission1a = document.getElementById("M01a");
                if (dict.mission1a == 1) {
                    score += 20;
                    mission1a.checked = true;
                } else {
                    mission1a.checked = false;
                }

                var mission2a = document.getElementById("M02a");
                score += dict.mission2a * 10;
                mission2a.value = dict.mission2a * 10;

                var mission2b = document.getElementById("M02b");
                if (dict.mission2b == 1 && dict.mission2a == 1) {
                    score += 20;
                    mission2b.checked = true;
                } else if (dict.mission2b == 1 && dict.mission2a == 2) {
                    score += 30;
                    mission2b.checked = true;
                } else if (dict.mission2b == 1 && dict.mission2a == 3) {
                    score += 10;
                    mission2b.checked = true;
                } else {
                    mission2b.checked = false;
                }

                var mission3a = document.getElementById("M03a");
                if (dict.mission3a == 1) {
                    score += 20;
                    mission3a.checked = true;
                } else {
                    mission3a.checked = false;
                }

                var mission4a = document.getElementById("M04a");
                if (dict.mission4a == 1) {
                    score += 10;
                    mission4a.checked = true;
                } else {
                    mission4a.checked = false;
                }

                var mission4b = document.getElementById("M04b");
                if (dict.mission4b == 1) {
                    score += 20;
                    mission4b.checked = true;
                } else {
                    mission4b.checked = false;
                }

                var mission5a = document.getElementById("M05a");
                if (dict.mission5a == 1) {
                    score += 30;
                    mission5a.checked = true;
                } else {
                    mission5a.checked = false;
                }

                var mission6a = document.getElementById("M06a");
                if (dict.mission6a == 1) {
                    score += 10;
                    mission6a.checked = true;
                } else {
                    mission6a.checked = false;
                }

                var mission6b = document.getElementById("M06b");
                if (dict.mission6b == 1) {
                    score += 10;
                    mission6b.checked = true;
                } else {
                    mission6b.checked = false;
                }

                var mission7a = document.getElementById("M07a");
                if (dict.mission7a == 1) {
                    score += 20;
                    mission7a.checked = true;
                } else {
                    mission7a.checked = false;
                }

                var mission8a = document.getElementById("M08a");
                score += dict.mission10a * 10;
                mission8a.value = dict.mission8a * 10;

                var mission9a = document.getElementById("M09a");
                if (dict.mission9a == 1) {
                    score += 10;
                    mission9a.checked = true;
                } else {
                    mission9a.checked = false;
                }

                var mission9b = document.getElementById("M09b");
                if (dict.mission9b == 1) {
                    score += 10;
                    mission9b.checked = true;
                } else {
                    mission9b.checked = false;
                }

                var mission10a = document.getElementById("M10a");
                score += dict.mission10a * 10;
                mission10a.innerText = dict.mission10a;

                var mission11a = document.getElementById("M11a");
                score += dict.mission11a * 10;
                mission11a.value = dict.mission11a * 10;

                var mission12a = document.getElementById("M12a");
                if (dict.mission12a == 1) {
                    score += 10;
                    mission12a.checked = true;
                } else {
                    mission12a.checked = false;
                }

                var mission12b = document.getElementById("M12b");
                if (dict.mission12b == 1) {
                    score += 20;
                    mission12b.checked = true;
                } else {
                    mission12b.checked = false;
                }

                var mission13a = document.getElementById("M13a");
                if (dict.mission13a == 1) {
                    score += 10;
                    mission13a.checked = true;
                } else {
                    mission13a.checked = false;
                }

                var mission13b = document.getElementById("M13b");
                if (dict.mission13b == 1) {
                    score += 20;
                    mission13b.checked = true;
                } else {
                    mission13b.checked = false;
                }

                var mission14a = document.getElementById("M14a");
                score += Number(dict.mission14a) * 5;
                mission14a.innerText = dict.mission14a;

                var mission14b = document.getElementById("M14b");
                score += Number(dict.mission14b) * 5;
                mission14b.innerText = dict.mission14b;

                var mission15a = document.getElementById("M15a");
                if (dict.mission15a == 1) {
                    score += 10;
                    mission15a.checked = true;
                } else {
                    mission15a.checked = false;
                }

                var mission15b = document.getElementById("M15b");
                if (dict.mission15b == 1) {
                    score += 10;
                    mission15b.checked = true;
                } else {
                    mission15b.checked = false;
                }

                var mission15c = document.getElementById("M15c");
                if (dict.mission15c == 1) {
                    score += 10;
                    mission15c.checked = true;
                } else {
                    mission15c.checked = false;
                }

                var mission15d = document.getElementById("M15d");
                if (dict.mission15d == 1) {
                    score += 10;
                    mission15d.checked = true;
                } else {
                    mission15d.checked = false;
                }

                var mission15e = document.getElementById("M15e");
                if (dict.mission15e == 1) {
                    score += 10;
                    mission15e.checked = true;
                } else {
                    mission15e.checked = false;
                }

                var missionPT = document.getElementById("PrecisionTokens");
                missionPT.value = dict.missionPT;
                //missionPT.innerHTML = "<option value='mrbean'>" + dict.missionPT + "</option>";
                var scorelookup = { "": 0, 0: 0, 1: 10, 2: 15, 3: 25, 4: 35, 5: 50, 6: 50 };
                score += scorelookup[dict.missionPT];

                document.getElementById("TotalPoints").value = score;
                var total_score = score;

                console.log("Score: " + total_score);

                dictString = JSON.stringify(dict);
                console.log(dict);
            }

            function minus(mission) {
                var element = document.getElementById(mission);
                var value = Number(element.innerText) - 1;
                if (value < 0) value = 0;
                element.innerText = value;
                total_score();
            }

            function plus(mission) {
                var element = document.getElementById(mission);
                var value = Number(element.innerText) + 1;
                if (value > 3 && mission == "M10a") value = 3;
                if (value > 7 && mission == "M14a") value = 7;
                if (value > 7 && mission == "M14b") value = 7;
                element.innerText = value;
                total_score();
            }

            function startMatch() {
                if (document.getElementById("name").value == "" || document.getElementById("match").value == "") {
                    alert("Cannot start, please fill in the boxes.");
                    return;
                }

                var selection_screen = document.getElementsByClassName("selection-screen")[0];
                selection_screen.hidden = true;
                var scoring_screen = document.getElementsByClassName("scoring-screen")[0];
                scoring_screen.hidden = false;

                total_score();
            }

            function getMatch() {
                const http = new XMLHttpRequest();
                const form = new FormData();

                form.append("team", document.getElementById("name").value);
                form.append("match", document.getElementById("match").value);

                console.log(document.getElementById("name").value, document.getElementById("match").value);

                http.onreadystatechange = () => {
                    if (http.readyState == 4) {
                        if (http.status == 200) {
                            console.log("Success");
                            dict = JSON.parse(http.response);
                            total_score();
                        } else {
                            console.log("Failure");
                        }
                    }
                };

                http.open("POST", "/getMatch");
                http.send(form);

                startMatch();
            }

            var matchName = null;
            function createSocket() {
                window.socket = new WebSocket("ws://" + location.host + "/ws");
                window.socket.addEventListener("open", () => console.log("Socket opened"));
                window.socket.addEventListener("close", () => {
                    console.log("Socket closed");
                    document.getElementsByClassName("timer")[0].innerText = "Disconnected";
                    setTimeout(() => {
                        createSocket();
                    }, 500);
                });
                window.socket.addEventListener("message", (event) => {
                    let message = JSON.parse(event.data);
                    var timer = document.getElementsByClassName("timer")[0];
                    if (message.type == "matches") {
                        let matches = message.data;
                        if (matches.length == 0) {
                            matchName = null;
                        } else {
                            matchName = "Match " + matches[0].number.toString() + " (" + matches[0].field + ")";
                        }
                    } else if (message.type == "timer") {
                        let time = message.data;
                        let timeText =
                            time == null
                                ? "2:30"
                                : Math.floor(time / 60).toString() + ":" + (time % 60).toString().padStart(2, "0");
                        if (matchName == null) {
                            timer.innerText = timeText;
                        } else {
                            timer.innerText = matchName + " - " + timeText;
                        }
                    }
                });
            }

            window.addEventListener("load", () => {
                createSocket();
            });
        </script>

        <style>
            body {
                font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", "Lucida Sans", Arial, sans-serif;
                background-color: rgb(255, 248, 189);
            }

            div.timer {
                position: fixed;
                left: 0%;
                width: 100%;
                top: 0%;
                height: 75px;
                background-color: black;
                color: white;
                text-align: center;
                line-height: 75px;
                font-size: 40px;
            }

            div.selection-screen {
                line-height: 175%;
                text-align: center;

                position: absolute;
                left: 50%;
                top: calc(50% + 37.5px);
                transform: translate(-50%, -50%);
            }

            p {
                font-weight: bold;
                font-size: 23px;
                text-align: center;
            }

            div.scoring-screen {
                padding-top: 75px;
            }

            div.scoring-screen th {
                text-align: center;
            }

            div.scoring-screen td:last-child {
                text-align: center;
            }

            div.scoring-screen input[type="checkbox"] {
                width: 40px;
                height: 40px;
            }

            table,
            tr {
                background-color: hsl(180, 41%, 89%);
                border: 2px solid;
                border-collapse: collapse;
            }

            th {
                height: 40px;
                padding: 10px;
            }

            td {
                padding: 10px;
                text-align: left;
            }
        </style>
    </head>
    <body>
        <div class="timer">Disconnected</div>

        <!-- Selection screen -->
        <div class="selection-screen">
            <p>FLL MASTERPIECE Score Check</p>
            <table>
                <tbody>
                    <tr>
                        <td>Team Number:</td>
                        <td><input type="number" id="name" /></td>
                    </tr>
                    <tr>
                        <td>Match Number:</td>
                        <td><input type="number" id="match" min="0" /></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; vertical-align: middle">
                            <input
                                type="button"
                                value="Done"
                                style="height: 40px; width: 100px"
                                onclick="javascript:getMatch()"
                            />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Scoring screen -->
        <div hidden class="scoring-screen">
            <p>FLL MASTERPIECE SCORING APP</p>
            <table>
                <tbody>
                    <tr>
                        <th colspan="2">Equipment Inspection</th>
                    </tr>
                    <tr>
                        <td>
                            During the pre-match inspection, did the robot and all its equipment fit completely in one
                            launch area while being under a height of 12 inches?
                        </td>
                        <td>
                            <input type="checkbox" id="M00a" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 1: 3D Cinema</th>
                    </tr>
                    <tr>
                        <td>Is the red beam completely to the right?</td>
                        <td>
                            <input type="checkbox" id="M01a" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 2: Theater Scene Change</th>
                    </tr>
                    <tr>
                        <td>If the red flag is down, what is the active scene's color?</td>
                        <td>
                            <select id="M02a" name="M02a" onchange="total_score();">
                                <option value="0">Not Completed</option>
                                <option value="10">Blue</option>
                                <option value="20">Pink</option>
                                <option value="30">Orange</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Bonus: do both teams have the same colored scene?</td>
                        <td>
                            <input type="checkbox" id="M02b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 3: Immersive Experience</th>
                    </tr>
                    <tr>
                        <td>Are all three screens raised vertically?</td>
                        <td>
                            <input type="checkbox" id="M03a" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 4: Masterpiece</th>
                    </tr>
                    <tr>
                        <td>Is the art piece at least partially in the museum area?</td>
                        <td>
                            <input type="checkbox" id="M04a" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Is the art piece completely supported by the pedestal?</td>
                        <td>
                            <input type="checkbox" id="M04b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 5: Augmented Reality Statue</th>
                    </tr>
                    <tr>
                        <td>Is your orange lever completely to the right?</td>
                        <td>
                            <input type="checkbox" id="M05a" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 6: Music Concert Lights and Sounds</th>
                    </tr>
                    <tr>
                        <td>Is the sound lever completely to the left?</td>
                        <td>
                            <input type="checkbox" id="M06a" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Is the light lever completely down?</td>
                        <td>
                            <input type="checkbox" id="M06b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 7: Hologram Performer</th>
                    </tr>
                    <tr>
                        <td>Is the orange activator past the black line?</td>
                        <td>
                            <input type="checkbox" id="M07a" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 8: Rolling Camera</th>
                    </tr>
                    <tr>
                        <td>Which color has the camera most recently rolled past?</td>
                        <td>
                            <select id="M08a" name="M08a" onchange="total_score();">
                                <option value="0">Not Completed</option>
                                <option value="10">Darkest Blue</option>
                                <option value="20">Medium Blue</option>
                                <option value="30">Lightest Blue</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th colspan="2">Mission 9: Movie Set</th>
                    </tr>
                    <tr>
                        <td>Is the boat past the scene line and touching the mat?</td>
                        <td><input type="checkbox" id="M09a" onchange="total_score();" /></td>
                    </tr>
                    <tr>
                        <td>Is the camera at least partially inside the target area and touching the mat?</td>
                        <td>
                            <input type="checkbox" id="M09b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 10: Sound Mixer</th>
                    </tr>
                    <tr>
                        <td>How many of the sliders have been raised?</td>
                        <td>
                            <input type="button" value="-" onclick="minus('M10a')" />
                            <span id="M10a">0</span>
                            <input type="button" value="+" onclick="plus('M10a')" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 11: Lightshow</th>
                    </tr>
                    <tr>
                        <td>Which color is the arrow pointing at?</td>
                        <td>
                            <select id="M11a" name="M11a" onchange="total_score();">
                                <option value="0">Not Completed</option>
                                <option value="10">Yellow</option>
                                <option value="20">Green</option>
                                <option value="30">Blue</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 12: Virtual Reality Artist</th>
                    </tr>
                    <tr>
                        <td>Has the chicken moved?</td>
                        <td>
                            <input type="checkbox" id="M12a" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Has the chicken moved over or past the lavendar dot?</td>
                        <td>
                            <input type="checkbox" id="M12b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 13: Craft Creator</th>
                    </tr>
                    <tr>
                        <td>Is the orange and white lid completely open?</td>
                        <td>
                            <input type="checkbox" id="M13a" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Is the pink latch pointing straight down?</td>
                        <td>
                            <input type="checkbox" id="M13b" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 14: Audience Delivery</th>
                    </tr>
                    <tr>
                        <td>How many audience members are in destinations?</td>
                        <td>
                            <input type="button" value="-" onclick="minus('M14a')" />
                            <span id="M14a">0</span>
                            <input type="button" value="+" onclick="plus('M14a')" />
                        </td>
                    </tr>
                    <tr>
                        <td>How many destinations have at least one person fully in them?</td>
                        <td>
                            <input type="button" value="-" onclick="minus('M14b');" />
                            <span id="M14b">0</span>
                            <input type="button" value="+" onclick="plus('M14b')" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Mission 15: Expert Delivery</th>
                    </tr>
                    <tr>
                        <td>Which experts have been delivered?</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Sam is in the Movie Set</td>
                        <td>
                            <input type="checkbox" id="M15a" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Anna is in the Museum</td>
                        <td>
                            <input type="checkbox" id="M15b" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Noah is in the Music Concert</td>
                        <td>
                            <input type="checkbox" id="M15c" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Izzy is in the Skate Park</td>
                        <td>
                            <input type="checkbox" id="M15d" onchange="total_score();" />
                        </td>
                    </tr>
                    <tr>
                        <td>Emily is in the Cinema</td>
                        <td>
                            <input type="checkbox" id="M15e" onchange="total_score();" />
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Precision Tokens</th>
                    </tr>
                    <tr>
                        <td>Remaining tokens at the end of the match:</td>
                        <td>
                            <label for="PrecisionTokens"></label>
                            <select id="PrecisionTokens" name="PrecisionTokens" onchange="total_score();">
                                <option value="">--Choose an Option--</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2">Team Review</th>
                    </tr>

                    <tr>
                        <th style="text-align: left">Final Score</th>
                        <td><input type="number" id="TotalPoints" value="0" readonly /></td>
                    </tr>

                    <tr>
                        <th style="text-align: left">Team Initials</th>
                        <td><input type="text" id="TeamInitials" /></td>
                    </tr>

                    <tr>
                        <th colspan="2">Gracious Professionalism</th>
                    </tr>

                    <!-- <tr>
                        <td>Level of Gracious Professionalism displayed at the robot game table:</td>
                        <td>
                            <label for="GP"></label>
                            <select id="GP" name="GP">
                                <option value="">--Choose an Option--</option>
                                <option value="2">Developing</option>
                                <option value="3">Accomplished</option>
                                <option value="4">Exceeds</option>
                            </select>
                        </td>
                    </tr> -->
                </tbody>
            </table>
        </div>
    </body>
</html>
